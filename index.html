<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ò‡§∞‡•ç‡§§‡•Ä ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞‡§ï‡•ã ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§°‡•ç‡§Ø‡§æ‡§∏‡§¨‡•ã‡§∞‡•ç‡§° (‡§¨‡§ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡§Æ‡•ç‡§¨‡§§‡•ç)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================
        // --- 1. FIREBASE CONFIGURATION & ID MANAGEMENT ---
        //
        // NOTE: When deployed externally (like GitHub Pages), you MUST uncomment 
        // and fill in the two manual constants below to enable Cloud Firestore sync.
        // =========================================================================

        // üö® ACTION REQUIRED: UNCOMMENT AND REPLACE PLACEHOLDERS BELOW! üö®
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY", // Replace with your Firebase Web API Key
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // Replace with your Project ID
            projectId: "YOUR_PROJECT_ID", // Replace with your Project ID
            // Add other config keys (storageBucket, messagingSenderId, appId) if needed
        };
        const MANUAL_FAMILY_ID = "GHARTI-FAMILY-CODE"; // <--- Set a unique family ID/Code here (e.g., 'GHARTI-FAMILY-2082')
        const MANUAL_AUTH_TOKEN = null; // Leave as null unless you are using a custom auth setup

        // --- CANVAS PROVIDED CONFIGURATION (Default) ---
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const canvasFirebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const canvasAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Determine which set of configurations to use
        const useManualConfig = typeof MANUAL_FIREBASE_CONFIG !== 'undefined' && MANUAL_FIREBASE_CONFIG.projectId && MANUAL_FIREBASE_CONFIG.projectId !== 'YOUR_PROJECT_ID'; // Added check to ensure it's filled

        const familyId = useManualConfig 
            ? MANUAL_FAMILY_ID 
            : canvasAppId || 'local-app-id'; // Use canvas ID or local fallback

        const firebaseConfig = useManualConfig 
            ? MANUAL_FIREBASE_CONFIG 
            : canvasFirebaseConfig;

        const initialAuthToken = useManualConfig
            ? MANUAL_AUTH_TOKEN
            : canvasAuthToken;


        // --- Global Firebase & Auth Setup ---
        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;
        let unsubscribeSnapshot = null;
        let saveTimeout = null;
        let isLocalMode = false; 
        
        const syncStatusEl = document.getElementById('syncStatus');
        const bsYearSelector = document.getElementById('bsYearSelector');
        const bsMonthSelector = document.getElementById('bsMonthSelector');
        const familyCodeDisplayEl = document.getElementById('familyCodeDisplay'); 

        // Display the calculated Family ID
        if (familyCodeDisplayEl) {
            familyCodeDisplayEl.textContent = familyId.toUpperCase();
        }
        
        /**
         * Generates the unique internal key (BS_YYYY-MM_Index) for Firestore/LocalStorage.
         * @returns {string} The unique month key (e.g., '2082-01')
         */
        function getMonthKey() {
            const year = bsYearSelector.value;
            // Month index is 0-11, so we add 1 and pad to 2 digits (01-12)
            const monthIndex = parseInt(bsMonthSelector.value) + 1;
            const monthKey = `${year}-${monthIndex.toString().padStart(2, '0')}`;
            return monthKey;
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            // Check if MANUAL config was provided OR if Canvas config is present
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                console.warn("Running in local mode: Firebase configuration missing or incomplete.");
                isAuthReady = true; 
                isLocalMode = true; 
                currentUserId = 'local_user'; 
                syncStatusEl.textContent = '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: Firebase ‡§ï‡§®‡•ç‡§´‡§ø‡§ó ‡§π‡§∞‡§æ‡§á‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§ (Local Storage ‡§Æ‡•ã‡§°)';
                window.loadMonthData(getMonthKey()); 
                return; 
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Use anonymous sign-in for public/unauthenticated access
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        // Status message updated to reflect shared data
                        syncStatusEl.textContent = '‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§ú‡§°‡§æ‡§® ‡§≠‡§Ø‡•ã‡•§ (‡§∏‡§æ‡§ù‡§æ ‡§°‡§æ‡§ü‡§æ)'; 
                        window.loadMonthData(getMonthKey());
                    } else {
                        currentUserId = crypto.randomUUID(); 
                        isAuthReady = true;
                        syncStatusEl.textContent = '‡§Ö‡§§‡§ø‡§•‡§ø ‡§Æ‡•ã‡§°‡§Æ‡§æ ‡§ú‡§°‡§æ‡§® ‡§≠‡§Ø‡•ã‡•§';
                        window.loadMonthData(getMonthKey());
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                syncStatusEl.textContent = '‡§ú‡§°‡§æ‡§® ‡§Ö‡§∏‡§´‡§≤: ' + error.message;
            }
        }
        
        // --- LOCAL STORAGE Data Management ---

        function saveLocalData(monthKey) {
            const dataToSave = { income: getCurrentList('income'), expense: getCurrentList('expense') };
            try {
                const storageKey = `fm_data_${monthKey}`;
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                // Status message update to ensure consistency
                const yearMonthDisplay = monthKey.substring(0, 7); // e.g., '2082-01'
                syncStatusEl.textContent = `${yearMonthDisplay} ‡§ï‡•ã ‡§°‡§æ‡§ü‡§æ Local Storage ‡§Æ‡§æ ‡§¨‡§ö‡§§ ‡§≠‡§Ø‡•ã‡•§`;
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                syncStatusEl.textContent = 'Local Storage ‡§Æ‡§æ ‡§¨‡§ö‡§§ ‡§Ö‡§∏‡§´‡§≤‡•§';
            }
        }

        function loadLocalData(monthKey) {
            try {
                const storageKey = `fm_data_${monthKey}`;
                const storedData = localStorage.getItem(storageKey);
                const yearMonthDisplay = monthKey.substring(0, 7); // e.g., '2082-01'

                if (storedData) {
                    const data = JSON.parse(storedData);
                    populateLists(data.income || [], data.expense || []);
                    // Updated status message to match user request: '2082-01 ‡§ï‡•ã ‡§°‡§æ‡§ü‡§æ Local Storage ‡§¨‡§æ‡§ü ‡§≤‡•ã‡§° ‡§≠‡§Ø‡•ã‡•§'
                    syncStatusEl.textContent = `${yearMonthDisplay} ‡§ï‡•ã ‡§°‡§æ‡§ü‡§æ Local Storage ‡§¨‡§æ‡§ü ‡§≤‡•ã‡§° ‡§≠‡§Ø‡•ã‡•§`;
                } else {
                    // FIX: If no data is found, load empty lists instead of the same initialData
                    populateLists([], []); 
                    syncStatusEl.textContent = `${yearMonthDisplay} ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§ï‡•Å‡§®‡•à ‡§°‡§æ‡§ü‡§æ ‡§´‡•á‡§≤‡§æ ‡§™‡§∞‡•á‡§®‡•§ ‡§®‡§Ø‡§æ‡§Å ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§`;
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                // We keep initialData as a backup if loading fails completely, but not for new months.
                populateLists(initialData.income, initialData.expense); 
                syncStatusEl.textContent = 'Local Storage ‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§® ‡§Ö‡§∏‡§´‡§≤, ‡§™‡•Ç‡§∞‡•ç‡§µ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§°‡§æ‡§ü‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡§ø‡§Ø‡•ã‡•§';
            }
        }

        // --- Firestore Data Management ---

        /**
         * Gets the Firestore Document Reference for shared family data.
         * Data path uses the familyId for collaboration among all family members.
         */
        function getDocRef(monthKey) {
            if (!db || isLocalMode) return null; 
            
            // Public shared data path: /artifacts/{familyId}/public/data/gharti_finances/{monthKey}
            const collectionName = 'gharti_finances'; 
            // We use the familyId (which comes from __app_id or MANUAL_FAMILY_ID) as the top-level artifact ID
            const docPath = `/artifacts/${familyId}/public/data/${collectionName}/${monthKey}`;
            const docRef = doc(db, docPath);
            return { docRef };
        }

        /**
         * Saves the current cash flow data to Firestore (or localStorage).
         */
        function saveMonthData() {
            const monthKey = getMonthKey();
            if (isLocalMode) {
                saveLocalData(monthKey);
                return;
            }

            if (!isAuthReady || !db) {
                return;
            }
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const docData = getDocRef(monthKey);
                if (!docData) return;
                const { docRef } = docData;

                syncStatusEl.textContent = '‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§Æ‡§æ ‡§°‡§æ‡§ü‡§æ ‡§¨‡§ö‡§§ ‡§ó‡§∞‡•ç‡§¶‡•à...';
                
                const dataToSave = {
                    income: getCurrentList('income'),
                    expense: getCurrentList('expense'),
                };

                try {
                    await setDoc(docRef, dataToSave, { merge: true });
                    syncStatusEl.textContent = '‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§¨‡§ö‡§§ ‡§∏‡§´‡§≤! (' + new Date().toLocaleTimeString('ne-NP') + ')';
                } catch (e) {
                    console.error("Error saving document: ", e);
                    syncStatusEl.textContent = '‡§ï‡•ç‡§≤‡§æ‡§â‡§° ‡§¨‡§ö‡§§ ‡§Ö‡§∏‡§´‡§≤: ' + e.message.substring(0, 50) + '...';
                }
            }, 1000); 
        }
        window.saveMonthData = saveMonthData; 

        /**
         * Fetches and listens for real-time data for the given month from Firestore (or localStorage).
         */
        window.loadMonthData = function(monthKey) {
             if (!isAuthReady) {
                return;
            }
            
            if (isLocalMode) {
                loadLocalData(monthKey);
                return;
            }

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }

            const docData = getDocRef(monthKey);
            if (!docData) return;
            const { docRef } = docData;

            syncStatusEl.textContent = `B.S. ${monthKey.split('-')[0]} ${nepaliMonths[parseInt(monthKey.split('-')[1]) - 1]} ‡§ï‡•ã ‡§°‡§æ‡§ü‡§æ ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§¨‡§æ‡§ü ‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§¶‡•à...`;
            
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    populateLists(data.income || [], data.expense || []);
                    syncStatusEl.textContent = `B.S. ${monthKey.split('-')[0]} ${nepaliMonths[parseInt(monthKey.split('-')[1]) - 1]} ‡§ï‡•ã ‡§∏‡§æ‡§ù‡§æ ‡§°‡§æ‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§≠‡§Ø‡•ã‡•§`;
                } else {
                    console.log(`No data found for ${monthKey}. Starting blank.`);
                    // FIX: If no data exists, load empty lists instead of the same initialData
                    populateLists([], []); 
                    // Do not auto-save. Let the user input data which triggers a save later.
                    syncStatusEl.textContent = `B.S. ${monthKey.split('-')[0]} ${nepaliMonths[parseInt(monthKey.split('-')[1]) - 1]} ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§ï‡•Å‡§®‡•à ‡§∏‡§æ‡§ù‡§æ ‡§°‡§æ‡§ü‡§æ ‡§´‡•á‡§≤‡§æ ‡§™‡§∞‡•á‡§®‡•§ ‡§®‡§Ø‡§æ‡§Å ‡§Æ‡§π‡§ø‡§®‡§æ ‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§`;
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                syncStatusEl.textContent = '‡§∏‡§æ‡§ù‡§æ ‡§°‡§æ‡§ü‡§æ ‡§∏‡•Å‡§®‡•ç‡§® ‡§Ö‡§∏‡§´‡§≤: ' + error.message;
            });
        }
        
        // --- BIKRAM SAMBAT (BS) UI LOGIC ---
        
        const nepaliMonths = [
            "‡§µ‡•à‡§∂‡§æ‡§ñ (Baisakh)", "‡§ú‡•á‡§† (Jestha)", "‡§Ö‡§∏‡§æ‡§∞ (Ashar)", "‡§∂‡•ç‡§∞‡§æ‡§µ‡§£ (Shrawan)", 
            "‡§≠‡§¶‡•å (Bhadra)", "‡§Ö‡§∏‡•ã‡§ú (Ashwin)", "‡§ï‡§æ‡§∞‡•ç‡§§‡§ø‡§ï (Kartik)", "‡§Æ‡§Ç‡§∏‡§ø‡§∞ (Mangsir)", 
            "‡§™‡•Å‡§∏ (Poush)", "‡§Æ‡§æ‡§ò (Magh)", "‡§´‡§æ‡§≤‡•ç‡§ó‡•Å‡§® (Falgun)", "‡§ö‡•à‡§§‡•ç‡§∞ (Chaitra)"
        ];

        /**
         * Populates the year and month selectors with BS data.
         */
        function setupBSSelectors() {
            // Populate BS Year Selector (from 2075 to 2085)
            const currentBSYear = 2082; // Assuming current year is 2082 B.S. for initialization
            const currentBSMonthIndex = 0; // Assuming Baisakh (index 0)

            for (let y = 2075; y <= 2085; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                bsYearSelector.appendChild(option);
            }
            bsYearSelector.value = currentBSYear;

            // Populate BS Month Selector
            nepaliMonths.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index; // Store index 0-11
                option.textContent = month;
                bsMonthSelector.appendChild(option);
            });
            bsMonthSelector.value = currentBSMonthIndex; // Set default month

            // Add change listener to both selectors
            const selectorChangeListener = () => {
                // When month or year changes, load new data
                if (isAuthReady) {
                    window.loadMonthData(getMonthKey());
                }
            };

            bsYearSelector.addEventListener('change', selectorChangeListener);
            bsMonthSelector.addEventListener('change', selectorChangeListener);
        }
        
        /**
         * Changes the selected month and year in the BS selectors.
         * @param {number} direction - -1 for previous month, 1 for next month.
         */
        window.changeMonth = function(direction) {
            let currentYear = parseInt(bsYearSelector.value);
            let currentMonthIndex = parseInt(bsMonthSelector.value); // 0 to 11

            let newMonthIndex = currentMonthIndex + direction;
            let newYear = currentYear;
            
            const minYear = 2075;
            const maxYear = 2085;

            // Handle year rollovers
            if (newMonthIndex < 0) {
                newMonthIndex = 11; // December (Chaitra)
                newYear--;
            } else if (newMonthIndex > 11) {
                newMonthIndex = 0; // January (Baisakh)
                newYear++;
            }
            
            // Check boundaries
            if (newYear < minYear || newYear > maxYear) {
                // Show a brief message without using alert/confirm
                syncStatusEl.textContent = `‡§∏‡§ø‡§Æ‡§æ‡§®‡§æ ‡§™‡•Å‡§ó‡•ç‡§Ø‡•ã! ‡§°‡§æ‡§ü‡§æ ${minYear} ‡§¶‡•á‡§ñ‡§ø ${maxYear} B.S. ‡§∏‡§Æ‡•ç‡§Æ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§õ‡•§`;
                return;
            }

            // Update selectors. This will automatically trigger the data load via the existing change listener.
            bsYearSelector.value = newYear;
            bsMonthSelector.value = newMonthIndex;
            
            // Manually trigger load if the change event doesn't fire (sometimes happens when setting .value)
            if (isAuthReady) {
                window.loadMonthData(getMonthKey());
            }
        }
        
        /**
         * Copies the Family Code (appId) to the clipboard.
         */
        window.copyFamilyCode = function() {
            const code = familyId.toUpperCase(); // Use the determined familyId
            
            // Fallback for clipboard API which might not work in iframe
            try {
                const el = document.createElement('textarea');
                el.value = code;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                syncStatusEl.textContent = `‡§ï‡•ã‡§° ('${code}') ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡§™‡•Ä ‡§≠‡§Ø‡•ã!`;
            } catch (err) {
                syncStatusEl.textContent = '‡§ï‡§™‡•Ä ‡§ó‡§∞‡•ç‡§® ‡§Ö‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã, ‡§ï‡•ã‡§°‡§≤‡§æ‡§à ‡§Æ‡•ç‡§Ø‡§æ‡§®‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§ï‡§™‡•Ä ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§';
                console.error('Copy failed:', err);
            }
        }
        
        /**
         * Navigates to the file source (placeholder for GitHub/Canvas URL).
         */
        window.viewSource = function() {
            const githubUrl = "YOUR_GITHUB_REPOSITORY_URL_HERE"; // <<< Fill this URL when deploying to GitHub Pages

            if (githubUrl.includes("YOUR_GITHUB_REPOSITORY_URL_HERE")) {
                syncStatusEl.textContent = "‡§ï‡•É‡§™‡§Ø‡§æ GitHub ‡§Æ‡§æ ‡§°‡§ø‡§™‡•ç‡§≤‡•ã‡§Ø ‡§ó‡§∞‡•á‡§™‡§õ‡§ø ‡§Ø‡•ã ‡§¨‡§ü‡§®‡§Æ‡§æ URL ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç!";
            } else {
                window.open(githubUrl, '_blank');
            }
        }


        // Initial setup on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            setupBSSelectors(); // Setup the Nepali Calendar UI
            initFirebase(); // Start Firebase initialization
            calculateConsolidation(); // Initial consolidation calculation
        });
        
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Mukta:wght@200;300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Mukta', 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
            padding: 1.5rem;
        }
        .input-field, .summary-text, select {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.15s ease-in-out;
        }
        .input-field:focus, select:focus {
            border-color: #4f46e5; /* indigo-600 */
        }
        .income-row, .expense-row {
            transition: background-color 0.2s;
        }
        .income-row:focus-within, .expense-row:focus-within {
            background-color: #f0f9ff; /* blue-50 */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">‡§ò‡§∞‡•ç‡§§‡•Ä ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞‡§ï‡•ã ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§°‡•ç‡§Ø‡§æ‡§∏‡§¨‡•ã‡§∞‡•ç‡§°</h1>
        <p class="text-center text-gray-600 mb-4">‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä, ‡§ñ‡§∞‡•ç‡§ö ‡§∞ ‡§ã‡§£‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£‡§π‡§∞‡•Ç ‡§Ø‡§π‡§æ‡§Å ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>

        <!-- Control Bar (Family Code, Month Selector, Export, Sync Status) -->
        <div class="card mb-6 flex flex-col md:flex-row items-center justify-between p-4 bg-white border-b-2 border-indigo-100 space-y-4 md:space-y-0">
            
            <!-- Family Sharing Info (Top-left) -->
            <div class="w-full md:w-1/3 text-center md:text-left">
                <p class="text-xs text-gray-500 font-semibold mb-1">‡§™‡§∞‡§ø‡§µ‡§æ‡§∞‡§ï‡•ã ‡§∏‡§æ‡§ù‡§æ ‡§°‡§æ‡§ü‡§æ ‡§ï‡•ã‡§° (Family Code):</p>
                <div class="flex items-center justify-center md:justify-start space-x-2">
                    <!-- Family Code Display -->
                    <span id="familyCodeDisplay" class="font-mono text-base font-extrabold text-purple-700 bg-purple-100 p-1.5 rounded-md border border-purple-300">Loading...</span>
                    <!-- Copy Button -->
                    <button onclick="copyFamilyCode()" title="‡§ï‡•ã‡§° ‡§ï‡§™‡•Ä ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" class="text-gray-500 hover:text-indigo-600 transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-6l-7-7m0 0a2 2 0 012.828 0L14 7.172"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a2 2 0 00-2-2H9a2 2 0 00-2 2v4"></path></svg>
                    </button>
                </div>
                <p class="text-xs text-red-500 mt-1">‡§Ø‡•ã ‡§ï‡•ã‡§° ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§∏‡§Å‡§ó ‡§∏‡§æ‡§ù‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>
            </div>

            <!-- Bikram Sambat Selectors (Center) -->
            <div class="flex items-center space-x-2 sm:space-x-4 w-full md:w-1/3 justify-center">
                <label class="font-bold text-gray-700 whitespace-nowrap">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§°‡§æ‡§ü‡§æ (B.S.):</label>
                <select id="bsYearSelector" class="input-field p-2 text-base font-mono focus:ring-indigo-500 focus:border-indigo-500"></select>
                <select id="bsMonthSelector" class="input-field p-2 text-base font-mono focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            
            <!-- Export and Sync Status (Right) -->
            <div class="flex flex-col items-end w-full md:w-1/3 space-y-2">
                <div class="flex space-x-2">
                    <!-- Export Button -->
                    <button onclick="exportDataAsCSV()" class="bg-indigo-500 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-600 transition duration-150 ease-in-out text-sm font-medium">
                        ‡§°‡§æ‡§ü‡§æ ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç (CSV)
                    </button>
                    <!-- View Source Button (New) -->
                    <button onclick="viewSource()" id="viewSourceButton" title="‡§´‡§æ‡§á‡§≤‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç (GitHub URL ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç)" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out text-sm font-medium shadow-md">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        ‡§∏‡•ç‡§∞‡•ã‡§§
                    </button>
                </div>
                <span id="syncStatus" class="text-sm italic text-indigo-500">‡§°‡§æ‡§ü‡§æ ‡§ú‡§°‡§æ‡§®‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§∞‡•ç‡§ñ‡§Å‡§¶‡•à...</span>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Monthly Cash Flow Management -->
            <div class="lg:col-span-2">
                <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-3 mb-4 text-indigo-600">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§∞ ‡§ñ‡§∞‡•ç‡§ö (Monthly Cash Flow)</h2>
                    <p class="text-sm text-gray-500 mb-4">‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï‡§π‡§∞‡•Ç ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ **‡§∏‡•ç‡§µ‡§§‡§É ‡§ó‡§£‡§®‡§æ ‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§Æ‡§æ ‡§¨‡§ö‡§§** ‡§π‡•Å‡§®‡•á‡§õ‡•§ (Family Code ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•Ä ‡§∏‡§æ‡§ù‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§°‡§æ‡§ü‡§æ)</p>

                    <div class="flex justify-between font-bold text-lg mb-2 pt-2 border-t">
                        <span class="w-1/2">‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</span>
                        <span class="w-1/2 text-right">‡§∞‡§ï‡§Æ (‡§∞‡•Å.)</span>
                    </div>

                    <!-- Income Section -->
                    <h3 class="text-xl font-medium text-green-700 mt-4 mb-2">‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (Earnings)</h3>
                    <div id="incomeList" class="space-y-2">
                        <!-- Income rows will be injected here -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="addListItem('income')" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out font-medium">
                            + ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                        </button>
                    </div>
                    
                    <!-- Expense Section -->
                    <h3 class="text-xl font-medium text-red-700 mt-6 mb-2 border-t pt-4">‡§ñ‡§∞‡•ç‡§ö/‡§ï‡§ø‡§∏‡•ç‡§§‡§æ‡§π‡§∞‡•Ç (Liabilities)</h3>
                    <div id="expenseList" class="space-y-2">
                        <!-- Expense rows will be injected here -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="addListItem('expense')" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out font-medium">
                            + ‡§ñ‡§∞‡•ç‡§ö/‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                        </button>
                    </div>

                    <!-- Summary -->
                    <div class="mt-8 pt-4 border-t-2 border-dashed border-gray-300">
                        <div class="flex justify-between items-center text-lg font-bold text-gray-700 py-2">
                            <span>‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä:</span>
                            <span id="totalIncome" class="summary-text bg-green-100 p-2 text-green-700">0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-gray-700 py-2">
                            <span>‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§ñ‡§∞‡•ç‡§ö:</span>
                            <span id="totalExpense" class="summary-text bg-red-100 p-2 text-red-700">0</span>
                        </div>
                        <div class="flex justify-between items-center text-xl font-extrabold mt-4 py-3 rounded-lg" id="netFlowContainer">
                            <span>‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ö‡§§/‡§ò‡§æ‡§ü‡§æ (Net Cash Flow):</span>
                            <span id="netFlow" class="summary-text p-3">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Month Navigation Buttons at the bottom -->
                <div class="flex justify-between mt-4 p-4">
                    <button onclick="changeMonth(-1)" class="flex items-center space-x-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out font-medium shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        <span>‡§Ö‡§ò‡§ø‡§≤‡•ç‡§≤‡•ã ‡§Æ‡§π‡§ø‡§®‡§æ</span>
                    </button>
                    <button onclick="changeMonth(1)" class="flex items-center space-x-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-150 ease-in-out font-medium shadow-md">
                        <span>‡§Ö‡§∞‡•ç‡§ï‡•ã ‡§Æ‡§π‡§ø‡§®‡§æ</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Loan Consolidation Proposal (Scenario Analysis) -->
            <div class="card lg:col-span-2">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-3 mb-4 text-indigo-600">‡§ã‡§£ ‡§∏‡§Æ‡§æ‡§Ø‡•ã‡§ú‡§® ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ (Loan Consolidation Proposal)</h2>

                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 rounded-lg bg-yellow-50">
                        <label for="currentTotalDebt" class="font-medium text-gray-700 w-1/2">‡§π‡§æ‡§≤‡§ï‡•ã ‡§ú‡§Æ‡•ç‡§Æ‡§æ ‡§§‡§ø‡§∞‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§ã‡§£ (‡§∞‡•Å. 27,25,000/-):</label>
                        <input type="number" id="currentTotalDebt" value="2725000" class="input-field p-2 w-1/2 text-right" oninput="calculateConsolidation()">
                    </div>

                    <div class="flex justify-between items-center p-3 rounded-lg bg-yellow-50">
                        <label for="proposedNewLoan" class="font-medium text-gray-700 w-1/2">‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§®‡§Ø‡§æ‡§Å ‡§ã‡§£ (‡§∞‡•Å. 30,00,000/-):</label>
                        <input type="number" id="proposedNewLoan" value="3000000" class="input-field p-2 w-1/2 text-right" oninput="calculateConsolidation()">
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-300">
                    <h3 class="text-xl font-medium text-gray-800 mb-4">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§≠‡§æ‡§∞‡§ï‡•ã ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£:</h3>

                    <div class="flex justify-between items-center py-2">
                        <span class="font-semibold text-gray-600">‡§π‡§æ‡§≤‡§ï‡•ã ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§≠‡§æ‡§∞:</span>
                        <span id="currentMonthlyBurden" class="font-semibold text-red-600 text-lg">77,000</span>
                    </div>

                    <div class="flex justify-between items-center py-2">
                        <span class="font-semibold text-gray-600">‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§®‡§Ø‡§æ‡§Å ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§≠‡§æ‡§∞:</span>
                        <span id="proposedMonthlyBurden" class="font-semibold text-green-600 text-lg">44,000</span>
                    </div>

                    <div class="flex justify-between items-center text-xl font-extrabold mt-4 py-3 rounded-lg" id="monthlySavingContainer">
                        <span>‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡§ö‡§§ (Potential Monthly Saving):</span>
                        <span id="monthlySaving" class="p-2">33,000</span>
                    </div>
                </div>

                <p class="text-sm text-gray-500 mt-4 italic">
                    <strong class="font-bold">‡§Ü‡§ß‡§æ‡§∞:</strong> ‡§π‡§æ‡§≤‡§ï‡•ã ‡§≠‡§æ‡§∞ (‡§∞‡•Å. 52,000 + ‡§¢‡§ø‡§ï‡•Å‡§∞‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ ‡§∞‡•Å. 25,000 = ‡§∞‡•Å. 77,000) ‡§∞ ‡§®‡§Ø‡§æ‡§Å ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ (‡§∞‡•Å. 44,000) ‡§ï‡•ã ‡§Ü‡§ß‡§æ‡§∞‡§Æ‡§æ ‡§ó‡§£‡§®‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã‡•§
                </p>
            </div>

        </div>
    </div>

    <script>
        // Initial Data - Kept here for reference, but no longer auto-loaded for every new month
        const initialData = {
            income: [
                { name: '‡§™‡•á‡§®‡•ç‡§∏‡§® (Pension)', amount: 35000, type: 'income' },
                { name: '‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä (Other Income)', amount: 25000, type: 'income' },
                { name: 'Gobin (Other Source)', amount: 40000, type: 'income' },
                { name: '‡§™‡§∏‡§≤‡§¨‡§æ‡§ü ‡§®‡§æ‡§´‡§æ (Profit on Sale)', amount: 10000, type: 'income' },
            ],
            expense: [
                { name: 'Global PL + TKK + B&T (‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ)', amount: 57000, type: 'expense' },
                { name: 'CYC-1 ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ (CYC Installment)', amount: 5000, type: 'expense' },
                { name: '‡§≠‡•Å‡§™‡•Å ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ (Bhupu Installment)', amount: 28300, type: 'expense' },
                { name: '‡§¢‡§ø‡§ï‡•Å‡§∞‡•Ä ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ (Dhikuri Installment)', amount: 25000, type: 'expense' },
                { name: '‡§∏‡§Æ‡•Ç‡§π NMB ‡§ï‡§ø‡§∏‡•ç‡§§‡§æ (Group Loan)', amount: 15000, type: 'expense' },
                { name: '‡§ò‡§∞ ‡§ñ‡§∞‡•ç‡§ö (Household Expenses)', amount: 10000, type: 'expense' },
                { name: '‡§¨‡§ø‡§™‡§ø‡§® ‡§ñ‡§∞‡•ç‡§ö (Bipin‚Äôs Expenses)', amount: 8000, type: 'expense' },
            ]
        };

        const incomeList = document.getElementById('incomeList');
        const expenseList = document.getElementById('expenseList');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const netFlowEl = document.getElementById('netFlow');
        const netFlowContainer = document.getElementById('netFlowContainer');
        const monthlySavingEl = document.getElementById('monthlySaving');
        // Note: bsYearSelector and bsMonthSelector are globally defined in the module script

        /**
         * Converts a number to a Nepali-style formatted string (e.g., 100000 -> 1,00,000)
         * @param {number} num 
         * @returns {string}
         */
        function formatNepaliCurrency(num) {
            if (typeof num !== 'number' || isNaN(num)) return num;
            const absoluteNum = Math.abs(num).toFixed(0);
            
            let result = '';
            if (absoluteNum.length > 3) {
                let lastThree = absoluteNum.substring(absoluteNum.length - 3);
                let otherNumbers = absoluteNum.substring(0, absoluteNum.length - 3);
                
                result = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + ',' + lastThree;
            } else {
                result = absoluteNum;
            }

            return (num < 0 ? '-' : '') + result;
        }

        /**
         * Calculates the total income, total expense, and net flow, and triggers auto-save.
         */
        function calculateTotals() {
            let totalIncome = 0;
            let totalExpense = 0;

            incomeList.querySelectorAll('input[type="number"]').forEach(input => {
                const amount = parseFloat(input.value) || 0;
                totalIncome += amount;
            });

            expenseList.querySelectorAll('input[type="number"]').forEach(input => {
                const amount = parseFloat(input.value) || 0;
                totalExpense += amount;
            });

            const netFlow = totalIncome - totalExpense;

            // Update DOM
            totalIncomeEl.textContent = formatNepaliCurrency(totalIncome);
            totalExpenseEl.textContent = formatNepaliCurrency(totalExpense);
            netFlowEl.textContent = formatNepaliCurrency(netFlow);

            // Apply styling based on net flow
            netFlowContainer.className = 'flex justify-between items-center text-xl font-extrabold mt-4 py-3 rounded-lg';

            if (netFlow > 0) {
                netFlowContainer.classList.add('bg-green-100', 'text-green-700');
                netFlowEl.classList.add('text-green-700');
            } else if (netFlow < 0) {
                netFlowContainer.classList.add('bg-red-100', 'text-red-700');
                netFlowEl.classList.add('text-red-700');
            } else {
                netFlowContainer.classList.add('bg-gray-100', 'text-gray-700');
                netFlowEl.classList.add('text-gray-700');
            }
            
            // Trigger save
            if (window.saveMonthData) {
                window.saveMonthData();
            }
        }
        window.calculateTotals = calculateTotals;

        /**
         * Creates an editable list item (row) for income or expense.
         */
        function createListItem(type, name, amount) {
            const row = document.createElement('div');
            row.className = `flex space-x-2 items-center p-2 ${type}-row`;
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = name;
            nameInput.placeholder = type === 'income' ? '‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä‡§ï‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§' : '‡§ñ‡§∞‡•ç‡§ö/‡§ï‡§ø‡§∏‡•ç‡§§‡§æ‡§ï‡•ã ‡§®‡§æ‡§Æ';
            nameInput.className = 'input-field p-2 flex-grow w-1/2 focus:ring-2 focus:ring-indigo-500 focus:outline-none';
            nameInput.oninput = calculateTotals; 

            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.value = amount;
            amountInput.min = 0;
            amountInput.placeholder = '‡§∞‡§ï‡§Æ';
            amountInput.className = 'input-field p-2 w-1/4 text-right focus:ring-2 focus:ring-indigo-500 focus:outline-none';
            amountInput.oninput = calculateTotals; 

            const removeButton = document.createElement('button');
            removeButton.innerHTML = '<svg class="w-5 h-5 text-gray-500 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>';
            removeButton.className = 'p-1 ml-2 transition';
            removeButton.onclick = () => {
                row.remove();
                calculateTotals(); 
            };

            row.appendChild(nameInput);
            row.appendChild(amountInput);
            row.appendChild(removeButton);

            return row;
        }

        /**
         * Adds a new, empty list item to the specified list.
         */
        function addListItem(type) {
            const listEl = type === 'income' ? incomeList : expenseList;
            const defaultName = type === 'income' ? '‡§®‡§Ø‡§æ‡§Å ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä' : '‡§®‡§Ø‡§æ‡§Å ‡§ñ‡§∞‡•ç‡§ö';
            const newItem = createListItem(type, defaultName, 0);
            listEl.appendChild(newItem);
            calculateTotals(); 
        }
        window.addListItem = addListItem; 

        /**
         * Clears the current lists and populates them with new data.
         */
        function populateLists(incomeData, expenseData) {
            incomeList.innerHTML = '';
            expenseList.innerHTML = '';
            
            incomeData.forEach(item => {
                incomeList.appendChild(createListItem('income', item.name, item.amount));
            });
            expenseData.forEach(item => {
                expenseList.appendChild(createListItem('expense', item.name, item.amount));
            });
            
            calculateTotals(); 
        }
        
        /**
         * Extracts the current data from the DOM to be saved.
         */
        function getCurrentList(type) {
            const listEl = type === 'income' ? incomeList : expenseList;
            const data = [];
            listEl.querySelectorAll('.flex').forEach(row => {
                const nameInput = row.querySelector('input[type="text"]');
                const amountInput = row.querySelector('input[type="number"]');
                if (nameInput && amountInput) {
                    data.push({
                        name: nameInput.value,
                        amount: parseFloat(amountInput.value) || 0
                    });
                }
            });
            return data;
        }

        /**
         * Exports the current month's data as a CSV file for manual backup.
         */
        window.exportDataAsCSV = function() {
            const monthKey = getMonthKey();
            const incomeData = getCurrentList('income');
            const expenseData = getCurrentList('expense');

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Get Nepali month name for display
            const bsYear = monthKey.split('-')[0];
            const bsMonthIndex = parseInt(monthKey.split('-')[1]) - 1;
            const monthName = nepaliMonths[bsMonthIndex];
            
            csvContent += `‡§Æ‡§π‡§ø‡§®‡§æ,B.S. ${bsYear} ${monthName}\n`;
            csvContent += "‡§ñ‡§£‡•ç‡§°,‡§∏‡•ç‡§∞‡•ã‡§§/‡§®‡§æ‡§Æ,‡§∞‡§ï‡§Æ\n";
            
            incomeData.forEach(item => {
                csvContent += `‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä,${item.name.replace(/,/g, ' ')},${item.amount}\n`; 
            });

            csvContent += "\n";
            csvContent += "‡§ñ‡§£‡•ç‡§°,‡§∏‡•ç‡§∞‡•ã‡§§/‡§®‡§æ‡§Æ,‡§∞‡§ï‡§Æ\n";
            
            expenseData.forEach(item => {
                csvContent += `‡§ñ‡§∞‡•ç‡§ö,${item.name.replace(/,/g, ' ')},${item.amount}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const fileName = `Financial_Data_BS_${bsYear}_${monthName.split(' ')[0]}.csv`;
            
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", fileName);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
            
            syncStatusEl.textContent = `‡§°‡§æ‡§ü‡§æ Export ‡§∏‡§´‡§≤! ${fileName} ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§≠‡§Ø‡•ã‡•§`;
        }

        /**
         * Calculates the consolidation savings based on static scenario values.
         */
        function calculateConsolidation() {
            const currentBurden = 77000; 
            const proposedBurden = parseFloat(document.getElementById('proposedNewLoan').value) > 0 ? 44000 : 0; 

            document.getElementById('currentMonthlyBurden').textContent = formatNepaliCurrency(currentBurden);
            document.getElementById('proposedMonthlyBurden').textContent = formatNepaliCurrency(proposedBurden);
            
            const saving = currentBurden - proposedBurden;
            monthlySavingEl.textContent = formatNepaliCurrency(saving);

            monthlySavingEl.parentElement.classList.remove('bg-red-100', 'text-red-700', 'bg-indigo-100', 'text-indigo-700');
            if (saving > 0) {
                monthlySavingEl.parentElement.classList.add('bg-indigo-100', 'text-indigo-700');
            } else {
                 monthlySavingEl.parentElement.classList.add('bg-red-100', 'text-red-700');
            }
        }
        window.calculateConsolidation = calculateConsolidation; 

    </script>
</body>
</html>
