<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>घर्ती परिवारको वित्तीय व्यवस्थापन ड्यासबोर्ड (बिक्रम सम्बत्) - बहु-ऋण</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Logging (for debugging)
        setLogLevel('Debug');

        // --- GLOBAL CONFIGURATION (MANDATORY FOR GITHUB DEPLOYMENT) ---
        
        const MANUAL_FAMILY_ID = 'GHARTI-FINANCES'; // Use a unique family code (e.g., 'GHARTI-2082')
        
        // --- END GLOBAL CONFIGURATION ---

        // Check for environment variables (Canvas/Platform)
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_FAMILY_ID;
        // Firebase configuration is loaded securely from the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : (typeof MANUAL_FIREBASE_CONFIG !== 'undefined' ? MANUAL_FIREBASE_CONFIG : null);
        // Authentication token is loaded securely from the environment
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = 'local_user';
        let currentYearBs = 2082;
        let currentMonthBs = 1; // Baisakh (बैशाख)

        const bsMonths = [
            'बैशाख (01)', 'जेठ (02)', 'असार (03)', 'श्रावण (04)', 'भदौ (05)', 'असोज (06)',
            'कार्तिक (07)', 'मंसिर (08)', 'पुस (09)', 'माघ (10)', 'फाल्गुन (11)', 'चैत (12)'
        ];

        // Unique document path for monthly data (Income/Expense/Monthly Extra Payments)
        const getMonthDocPath = (year, month) => {
            const familyId = userId; 
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            // Public path for shared family data
            return `artifacts/${appId}/public/data/gharti_finances/${monthKey}`;
        };
        
        // Unique document path for persistent loan configuration (used across all months)
        const getLoanConfigDocPath = () => {
             return `artifacts/${appId}/public/data/gharti_loans_config/global`;
        };

        // --- INITIAL DATA STRUCTURES ---

        const initialLoanConfig = {
            id: crypto.randomUUID(), // Unique ID for each loan
            name: "नयाँ ऋण",
            principal: 1000000,
            rate: 10.0,
            years: 5,
            startDateYear: 2082,
            startDateMonth: 1, 
            extraPrincipal: 0 // This is the monthly extra payment for the currently selected month
        };

        const initialData = {
            incomes: [{ name: "प्रमुख आय स्रोत", amount: 0 }],
            expenses: [
                { name: "घर भाडा/किस्ता", amount: 0 },
                { name: "खाद्यान्न", amount: 0 },
                { name: "उपयोगिता (बिजुली/पानी)", amount: 0 },
                { name: "शिक्षा", amount: 0 },
                { name: "परिवहन", amount: 0 },
                { name: "विविध", amount: 0 }
            ],
            // Dynamic loan configurations will be loaded/saved here
            loans: [
                 // Pre-populate with a sample loan
                 {...initialLoanConfig, id: crypto.randomUUID(), name: "गृह ऋण", principal: 2725000, rate: 12.0, years: 10}
            ]
        };

        // Global data structure for the current month/global settings
        let monthlyData = JSON.parse(JSON.stringify(initialData));

        // --- LOAN CALCULATION LOGIC ---
        
        const calculateEMI = (principal, annualRate, years) => {
            const rate = annualRate / 12 / 100;
            const months = years * 12;

            if (principal <= 0 || months <= 0 || rate <= 0) return 0;

            const power = Math.pow(1 + rate, months);
            const emi = principal * rate * power / (power - 1);
            return emi;
        };

        // Function to calculate loan status up to a target month (amortization logic)
        const calculateLoanStatus = (config, targetYearBs, targetMonthBs) => {
            
            const totalMonths = config.years * 12;
            if (totalMonths === 0 || config.principal <= 0) {
                return {
                    emi: 0, startBalance: 0, endBalance: 0, interestPaid: 0, principalPaid: 0, extraPrincipal: 0,
                    paymentsMadeTotal: 0, paymentsRemaining: 0, currentOutstandingBalance: 0, isPaidOff: true
                };
            }
            
            const emi = calculateEMI(config.principal, config.rate, config.years);
            const monthlyRate = config.rate / 12 / 100;
            const extraPrincipalForThisMonth = config.extraPrincipal || 0;
            
            let currentBalance = config.principal;
            let totalPaymentsMade = 0;
            
            const startMonthKey = config.startDateYear * 12 + config.startDateMonth;
            const targetMonthKey = targetYearBs * 12 + targetMonthBs;
            
            // 1. Calculate the starting balance for the target month
            for (let currentKey = startMonthKey; currentKey < targetMonthKey; currentKey++) {
                
                if (currentBalance <= 0.01) {
                    currentBalance = 0;
                    break;
                }
                
                // Determine which month this loop iteration represents in the loan's life
                const currentLoanMonthIndex = currentKey - startMonthKey + 1;

                const interest = currentBalance * monthlyRate;
                let scheduledPrincipal = emi - interest;
                
                // Handle final payment edge case
                if (emi > currentBalance + interest) {
                    scheduledPrincipal = currentBalance;
                }
                
                currentBalance -= scheduledPrincipal;
                totalPaymentsMade++;
            }
            
            // 2. Status for the Target Month
            let status = {
                emi: emi,
                startBalance: Math.max(0, currentBalance),
                endBalance: Math.max(0, currentBalance),
                interestPaid: 0,
                principalPaid: 0,
                extraPrincipal: extraPrincipalForThisMonth,
                paymentsMadeTotal: totalPaymentsMade,
                paymentsRemaining: totalMonths - totalPaymentsMade,
                currentOutstandingBalance: Math.max(0, currentBalance),
                isPaidOff: currentBalance <= 0.01
            };

            if (status.isPaidOff && status.startBalance <= 0.01) {
                status.paymentsRemaining = 0;
                status.paymentsMadeTotal = totalMonths;
                return status;
            }
            
            // Amortization for the current month
            const interest = status.startBalance * monthlyRate;
            let scheduledPrincipal = emi - interest;
            
            if (emi >= status.startBalance + interest) {
                scheduledPrincipal = status.startBalance;
                status.endBalance = 0;
            } else {
                status.endBalance -= scheduledPrincipal;
            }
            
            // Apply payments
            status.interestPaid = interest;
            
            // Apply extra principal
            status.endBalance -= status.extraPrincipal;
            status.principalPaid = scheduledPrincipal + status.extraPrincipal;
            
            if (status.endBalance < 0) {
                status.endBalance = 0;
            }
            
            if (status.startBalance > 0.01) {
                status.paymentsMadeTotal = totalPaymentsMade + 1;
            }
            status.paymentsRemaining = Math.max(0, totalMonths - status.paymentsMadeTotal);

            status.currentOutstandingBalance = status.endBalance;
            
            return status;
        };


        // --- UI RENDER FUNCTIONS ---

        // Main function to calculate all totals (Income, Expense, Loans)
        window.calculateTotals = function() {
            const incomeRows = document.querySelectorAll('#incomeList [data-amount]');
            const expenseRows = document.querySelectorAll('#expenseList [data-amount]');
            
            let totalIncome = 0;
            incomeRows.forEach(input => totalIncome += parseFloat(input.value) || 0);

            let totalExpense = 0;
            expenseRows.forEach(input => totalExpense += parseFloat(input.value) || 0);

            // Calculate total loan metrics dynamically
            let totalPrincipalReduction = 0;
            let totalOutstanding = 0;
            let totalScheduledEMI = 0;
            let maxPaymentsRemaining = 0; // Changed to track max

            monthlyData.loans.forEach(loan => {
                const status = calculateLoanStatus(loan, currentYearBs, currentMonthBs);
                totalPrincipalReduction += status.principalPaid;
                totalOutstanding += status.currentOutstandingBalance;
                totalScheduledEMI += status.emi;
                
                // Track the maximum remaining payments (longest loan)
                if (status.paymentsRemaining > maxPaymentsRemaining) {
                    maxPaymentsRemaining = status.paymentsRemaining;
                }
            });

            const netCashFlow = totalIncome - totalExpense;

            // Update UI for Cash Flow
            document.getElementById('totalIncome').textContent = `₹ ${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `₹ ${totalExpense.toFixed(2)}`;
            document.getElementById('totalPrincipalReduction').textContent = `₹ ${totalPrincipalReduction.toFixed(2)}`; 
            document.getElementById('netCashFlow').textContent = `₹ ${netCashFlow.toFixed(2)}`;

            // Update UI for Loan Summary
            document.getElementById('totalOutstandingBalance').textContent = `₹ ${totalOutstanding.toFixed(2)}`;
            document.getElementById('totalScheduledEMI').textContent = `₹ ${totalScheduledEMI.toFixed(2)}`;
            document.getElementById('totalPaymentsRemaining').textContent = maxPaymentsRemaining; 
            
            if (netCashFlow >= 0) {
                document.getElementById('netCashFlow').classList.remove('text-primary-red');
                document.getElementById('netCashFlow').classList.add('text-primary-green');
            } else {
                document.getElementById('netCashFlow').classList.remove('text-primary-green');
                document.getElementById('netCashFlow').classList.add('text-primary-red');
            }
            
            // Auto-save data after calculation
            window.saveMonthData(); 
            window.saveLoanConfigData();
        }
        
        // Function to create an input row (for income/expense)
        const createInputRow = (listId, item) => {
            const container = document.getElementById(listId);
            if (!container) return; // Safety check
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 input-row mb-2';
            div.innerHTML = `
                <input type="text" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm" 
                       value="${item.name || ''}" placeholder="शिर्षक" oninput="window.saveMonthData()" data-name>
                <input type="number" class="w-24 p-2 border border-gray-300 rounded-lg text-sm text-right focus:ring-blue-500 focus:border-blue-500" 
                       value="${item.amount || 0}" placeholder="रकम" oninput="window.calculateTotals()" data-amount>
                <button onclick="window.removeRow(this, '${listId}')" class="p-2 text-red-500 hover:text-red-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(div);
        }
        
        // Function to remove an input row
        window.removeRow = function(button, listId) {
            const row = button.closest('.input-row');
            if (row) {
                row.remove();
                window.calculateTotals(); 
            }
        }
        
        // Function to add a new empty row
        window.addRow = function(listId) {
             const newItem = { name: "नयाँ शीर्षक", amount: 0 };
             if (listId === 'incomeList') {
                 monthlyData.incomes.push(newItem);
             } else {
                 monthlyData.expenses.push(newItem);
             }
             createInputRow(listId, newItem);
             window.calculateTotals(); 
        }

        // Function to populate income and expense lists
        window.populateLists = function(data) {
            const incomeListEl = document.getElementById('incomeList');
            const expenseListEl = document.getElementById('expenseList');
            
            if(incomeListEl) incomeListEl.innerHTML = '';
            if(expenseListEl) expenseListEl.innerHTML = '';
            
            // Load Cash Flow Data 
            (data.incomes || initialData.incomes).forEach(item => createInputRow('incomeList', item));
            (data.expenses || initialData.expenses).forEach(item => createInputRow('expenseList', item));
            
            // Render Loans
            window.renderLoans(data.loans || initialData.loans);

            // Run calculations after loading data
            window.calculateTotals();
        }

        // --- LOAN MANAGEMENT FUNCTIONS ---

        // Saves monthly extra principal and re-calculates all totals
        window.saveLoanExtraPrincipal = function(element, loanId) {
            const newExtra = parseFloat(element.value) || 0;
            const loanIndex = monthlyData.loans.findIndex(l => l.id === loanId);

            if (loanIndex !== -1) {
                // Update the temporary monthly extra principal value
                monthlyData.loans[loanIndex].extraPrincipal = newExtra;
                window.calculateTotals(); // This triggers saveMonthData and saveLoanConfigData
            }
        }
        
        // Saves the loan configuration details (Principal, Rate, Years, Start Date, Name)
        window.saveLoanConfigDetail = function(element, loanId, key) {
            const loanIndex = monthlyData.loans.findIndex(l => l.id === loanId);
            const value = key === 'name' ? element.value : parseFloat(element.value);
            
            if (loanIndex !== -1) {
                monthlyData.loans[loanIndex][key] = value;
                // Important: clear extraPrincipal if main configuration changes, as the amortization resets
                if (key !== 'name') {
                    monthlyData.loans[loanIndex].extraPrincipal = 0; 
                    const extraInput = document.querySelector(`#loanCard-${loanId} [data-key="extraPrincipal"]`);
                    if (extraInput) extraInput.value = '0';
                }
                window.renderLoans(monthlyData.loans); // Re-render to update amortization details and totals
            }
        }

        window.addLoan = function() {
            const newLoan = {...initialLoanConfig, id: crypto.randomUUID(), name: `नयाँ ऋण ${monthlyData.loans.length + 1}`};
            monthlyData.loans.push(newLoan);
            window.renderLoans(monthlyData.loans);
            // Scroll to the new loan card
            setTimeout(() => {
                const newCard = document.getElementById(`loanCard-${newLoan.id}`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }

        window.deleteLoan = function(loanId) {
             const msgBox = document.createElement('div');
            msgBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            msgBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-3 text-red-600">ऋण मेटाउने पुष्टि गर्नुहोस्</h3>
                    <p class="text-gray-700">के तपाईं साँच्चै यो ऋण मेटाउन चाहनुहुन्छ? यो कार्य पूर्ववत गर्न सकिँदैन।</p>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">रद्द गर्नुहोस्</button>
                        <button onclick="window.confirmDeleteLoan('${loanId}'); this.closest('.fixed').remove();" class="px-4 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">निश्चित गर्नुहोस्</button>
                    </div>
                </div>
            `;
            document.body.appendChild(msgBox);
        }

        window.confirmDeleteLoan = function(loanId) {
            monthlyData.loans = monthlyData.loans.filter(l => l.id !== loanId);
            window.renderLoans(monthlyData.loans);
        }


        window.renderLoans = function(loans) {
            const container = document.getElementById('loansContainer');
            if (!container) return; // Add null check for container
            container.innerHTML = '';
            
            loans.forEach((loan, index) => {
                const status = calculateLoanStatus(loan, currentYearBs, currentMonthBs);
                container.innerHTML += window.getLoanCardHtml(loan, index + 1, status);
            });
            
            // After rendering, ensure the year/month selectors are populated and values are set
            window.setLoanDateSelectors(loans);
            window.calculateTotals(); // Final calculation pass
        }

        window.setLoanDateSelectors = function(loans) {
            loans.forEach(loan => {
                const yearSelect = document.getElementById(`loanStartYear-${loan.id}`);
                const monthSelect = document.getElementById(`loanStartMonth-${loan.id}`);
                
                // If selectors don't exist yet, skip (they will be created on the next render pass)
                if (!yearSelect || !monthSelect) return; 

                // Clear and repopulate years/months (ensures consistency)
                yearSelect.innerHTML = '';
                monthSelect.innerHTML = '';

                const startYear = 2080;
                const endYear = 2090;

                for (let y = startYear; y <= endYear; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    yearSelect.appendChild(option);
                }

                bsMonths.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = name;
                    monthSelect.appendChild(option);
                });

                // Set values based on the loan config
                yearSelect.value = loan.startDateYear;
                monthSelect.value = loan.startDateMonth;
            });
        }

        window.getLoanCardHtml = (loan, index, status) => {
            const isPaidOff = status.currentOutstandingBalance <= 0.01;
            const extraPrincipalForThisMonth = loan.extraPrincipal || 0;
            const scheduledPrincipal = status.principalPaid - extraPrincipalForThisMonth;
            
            const cardBgClass = isPaidOff ? 'bg-green-100 border-green-300' : 'bg-white border-gray-200';
            const statusText = isPaidOff ? 'ऋण चुक्ता भयो!' : 'सक्रिय';
            
            return `
                <div id="loanCard-${loan.id}" class="p-6 rounded-xl shadow-lg border ${cardBgClass} transition duration-300">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div class="flex items-center space-x-2">
                            <h2 class="text-xl font-semibold text-gray-800">
                                ${index}. 
                                <input type="text" value="${loan.name}" 
                                       oninput="window.saveLoanConfigDetail(this, '${loan.id}', 'name')" 
                                       class="text-xl font-semibold border-b border-dashed border-gray-400 focus:border-blue-500 focus:outline-none p-0.5 rounded-md"
                                       placeholder="ऋणको नाम">
                            </h2>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full ${isPaidOff ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                                ${statusText}
                            </span>
                        </div>
                        <button onclick="window.deleteLoan('${loan.id}')" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition duration-150" title="ऋण मेटाउनुहोस्">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Loan Configuration (Inputs) -->
                        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                            <h3 class="font-bold text-blue-700 mb-3 text-lg">ऋण विवरण (Configuration)</h3>
                            <div class="space-y-2">
                                <div>
                                    <label for="loanPrincipal-${loan.id}" class="text-xs text-gray-600 block">मूलधन (Principal - ₹)</label>
                                    <input type="number" id="loanPrincipal-${loan.id}" oninput="window.saveLoanConfigDetail(this, '${loan.id}', 'principal')" class="w-full p-2 border rounded-lg text-sm" value="${loan.principal.toFixed(0)}">
                                </div>
                                <div class="flex space-x-2">
                                    <div class="flex-1">
                                        <label for="loanRate-${loan.id}" class="text-xs text-gray-600 block">ब्याज दर (Rate - %)</label>
                                        <input type="number" id="loanRate-${loan.id}" oninput="window.saveLoanConfigDetail(this, '${loan.id}', 'rate')" class="w-full p-2 border rounded-lg text-sm" step="0.1" value="${loan.rate.toFixed(1)}">
                                    </div>
                                    <div class="flex-1">
                                        <label for="loanYears-${loan.id}" class="text-xs text-gray-600 block">अवधि (Years)</label>
                                        <input type="number" id="loanYears-${loan.id}" oninput="window.saveLoanConfigDetail(this, '${loan.id}', 'years')" class="w-full p-2 border rounded-lg text-sm" value="${loan.years.toFixed(0)}">
                                    </div>
                                </div>
                                <!-- Start Date -->
                                <div class="pt-2 border-t border-blue-300">
                                    <label class="text-xs text-gray-600 block mb-1">ऋण सुरु मिति</label>
                                    <div class="flex space-x-2">
                                        <select id="loanStartYear-${loan.id}" onchange="window.saveLoanConfigDetail(this, '${loan.id}', 'startDateYear')" class="p-2 border border-blue-300 rounded-lg text-sm bg-white flex-1"></select>
                                        <select id="loanStartMonth-${loan.id}" onchange="window.saveLoanConfigDetail(this, '${loan.id}', 'startDateMonth')" class="p-2 border border-blue-300 rounded-lg text-sm bg-white flex-1"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 pt-2 border-t border-blue-300 flex justify-between font-bold text-blue-700">
                                <span>निश्चित मासिक किस्ता (EMI):</span>
                                <span>₹ ${status.emi.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Monthly Tracking & Payment Input -->
                        <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                            <h3 class="font-bold text-yellow-800 mb-3 text-lg">भुक्तानी ट्र्याकिङ (<span class="text-sm font-medium text-gray-700">यस महिनाको लागि: <span id="currentMonthName-loan-${loan.id}"></span></span>)</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm font-medium">
                                    <span class="text-gray-600">सुरुको बाँकी रकम (Start Balance):</span>
                                    <span class="text-gray-800 font-bold">₹ ${status.startBalance.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm text-red-600">
                                    <span>ब्याज भुक्तानी (Interest Paid):</span>
                                    <span>₹ ${status.interestPaid.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm text-green-600">
                                    <span>तालिकाबद्ध मूलधन (Scheduled Principal):</span>
                                    <span>₹ ${Math.max(0, scheduledPrincipal).toFixed(2)}</span>
                                </div>
                                
                                <!-- Extra Principal Input -->
                                <div>
                                    <label for="extraPrincipal-${loan.id}" class="text-xs text-gray-600 block mt-2">अतिरिक्त मूलधन भुक्तानी (Extra Principal - ₹)</label>
                                    <input type="number" id="extraPrincipal-${loan.id}" 
                                           oninput="window.saveLoanExtraPrincipal(this, '${loan.id}')" 
                                           data-key="extraPrincipal"
                                           class="w-full p-2 border rounded-lg text-sm bg-yellow-100 font-bold" value="${extraPrincipalForThisMonth.toFixed(0)}">
                                </div>
                                <div class="flex justify-between text-sm text-primary-blue font-medium pt-1">
                                    <span>कुल अतिरिक्त मूलधन:</span>
                                    <span>₹ ${extraPrincipalForThisMonth.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-3 border-t border-yellow-300 space-y-2">
                                <div class="flex justify-between text-sm font-medium">
                                    <span class="text-gray-600">कुल किस्ता भुक्तानी (Total Payments Made):</span>
                                    <span class="font-bold">${status.paymentsMadeTotal}</span>
                                </div>
                                <div class="flex justify-between text-sm font-medium">
                                    <span class="text-gray-600">बाँकी किस्ता (Remaining Payments):</span>
                                    <span class="font-bold">${status.paymentsRemaining}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Outstanding Balance Summary -->
                        <div class="p-4 rounded-lg bg-red-100 border border-red-300 text-center">
                            <p class="text-sm font-medium text-red-800">अन्तिम बाँकी रकम (Outstanding Balance):</p>
                            <p class="text-2xl font-extrabold text-red-700 mt-1">₹ ${status.currentOutstandingBalance.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- DATA SAVING AND LOADING ---

        // Function to save monthly data (Income/Expense/Monthly Extra Principal)
        window.saveMonthData = async function() {
            const monthKey = `${currentYearBs}-${String(currentMonthBs).padStart(2, '0')}`;
            
            // 1. Get current data from UI
            const incomeList = document.querySelector('#incomeList');
            const expenseList = document.querySelector('#expenseList');

            if (!incomeList || !expenseList) return; // Add safety check

            monthlyData.incomes = Array.from(incomeList.querySelectorAll('.input-row')).map(row => ({
                name: row.querySelector('[data-name]').value,
                amount: parseFloat(row.querySelector('[data-amount]').value) || 0
            }));

            monthlyData.expenses = Array.from(expenseList.querySelectorAll('.input-row')).map(row => ({
                name: row.querySelector('[data-name]').value,
                amount: parseFloat(row.querySelector('[data-amount]').value) || 0
            }));
            
            // 2. Extract only the monthly extra principal payments from the loans array
            const monthlyLoanData = monthlyData.loans.map(loan => ({
                id: loan.id,
                extraPrincipal: loan.extraPrincipal || 0
            }));

            const dataToSave = {
                incomes: monthlyData.incomes,
                expenses: monthlyData.expenses,
                monthlyLoanData: monthlyLoanData // Only monthly variable part
            };


            if (db) {
                try {
                    const docRef = doc(db, getMonthDocPath(currentYearBs, currentMonthBs));
                    await setDoc(docRef, dataToSave, { merge: true });
                } catch (e) {
                    console.error("Firestore Save Error, switching to Local Save:", e);
                    window.saveLocalData(monthKey, dataToSave);
                }
            } else {
                window.saveLocalData(monthKey, dataToSave);
            }
            // FIX: Ensure DOM elements are available before updating status
            setTimeout(() => window.updateSyncStatus('क्लाउड बचत सफल! (साझा डाटा)', 'Success'), 0);
        }
        
        // Function to save global loan configuration (Name, Principal, Rate, Years, Start Date)
        window.saveLoanConfigData = async function() {
            const loansConfigToSave = monthlyData.loans.map(loan => ({
                id: loan.id,
                name: loan.name,
                principal: loan.principal,
                rate: loan.rate,
                years: loan.years,
                startDateYear: loan.startDateYear,
                startDateMonth: loan.startDateMonth,
            }));
            
            if (db) {
                try {
                    const docRef = doc(db, getLoanConfigDocPath());
                    await setDoc(docRef, { loans: loansConfigToSave }, { merge: false }); // Overwrite the global list
                } catch (e) {
                    console.error("Firestore Loan Config Save Error, switching to Local Save:", e);
                    localStorage.setItem('gharti_loans_config_global', JSON.stringify(loansConfigToSave));
                }
            } else {
                localStorage.setItem('gharti_loans_config_global', JSON.stringify(loansConfigToSave));
            }
        }
        
        // Function to load data from Cloud Firestore or Local Storage
        const loadMonthData = async (year, month) => {
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            // Fix: Deferring the status update to prevent race condition errors with DOM loading
            setTimeout(() => window.updateSyncStatus('डाटा लोड गर्दै... (Loading Data...)', 'Loading'), 0);
            
            if (window.unsubscribe) {
                window.unsubscribe();
            }

            // 1. Load Loan Config (Global/Persistent Data)
            let loansConfig = initialData.loans;
            if (db) {
                 try {
                    const configDocRef = doc(db, getLoanConfigDocPath());
                    const configUnsub = onSnapshot(configDocRef, (doc) => {
                        if (doc.exists() && doc.data().loans && doc.data().loans.length > 0) {
                            loansConfig = doc.data().loans;
                        }
                        // Continue to load monthly data after config is loaded
                        loadMonthlyDataSnapshot(year, month, loansConfig);
                    }, (error) => {
                        console.error("Firestore Config Snapshot Error, falling back to Local:", error);
                        loadLocalConfigAndMonthly(year, month, monthKey);
                    });
                    // Store the config listener to potentially unsubscribe later, though here we prioritize month listener
                } catch (e) {
                     loadLocalConfigAndMonthly(year, month, monthKey);
                }

            } else {
                loadLocalConfigAndMonthly(year, month, monthKey);
            }
        }
        
        const loadLocalConfigAndMonthly = (year, month, monthKey) => {
            try {
                 const globalLoanConfigString = localStorage.getItem('gharti_loans_config_global');
                 if (globalLoanConfigString) {
                     monthlyData.loans = JSON.parse(globalLoanConfigString);
                 } else {
                    monthlyData.loans = initialData.loans; // Ensure it initializes if nothing in local storage
                 }
            } catch(e) { console.error("Local Config Parse Error:", e); monthlyData.loans = initialData.loans; }
            
            // Now load monthly data
            const monthlyDataString = localStorage.getItem(`gharti_finances_${monthKey}`);
            loadMonthlyData(monthlyDataString);
            // FIX: Wrap synchronous status update to allow DOM to render.
            setTimeout(() => window.updateSyncStatus(`${monthKey} को डाटा Local Storage बाट लोड भयो। (Local Storage मोड)`, 'Local'), 0);
        }

        const loadMonthlyDataSnapshot = (year, month, loansConfig) => {
            const docRef = doc(db, getMonthDocPath(year, month));

            window.unsubscribe = onSnapshot(docRef, (doc) => {
                let monthlyVariables = {};
                if (doc.exists()) {
                    monthlyVariables = doc.data();
                    window.updateSyncStatus('क्लाउड जडान भयो। (रियल-टाइम अपडेट)', 'Success');
                } else {
                    window.updateSyncStatus('नयाँ महिना। बचत गर्न सुरु गर्नुहोस्।', 'Local');
                }
                
                // Merge persistent loans config with monthly variable data (extra principal)
                monthlyData = { 
                    incomes: monthlyVariables.incomes || initialData.incomes,
                    expenses: monthlyVariables.expenses || initialData.expenses,
                    loans: loansConfig.map(config => {
                        const monthlyEntry = monthlyVariables.monthlyLoanData?.find(m => m.id === config.id);
                        return { 
                            ...config, 
                            extraPrincipal: monthlyEntry?.extraPrincipal || 0
                        };
                    })
                };
                
                window.populateLists(monthlyData);
            }, (error) => {
                console.error("Firestore Monthly Snapshot Error, falling back to Local:", error);
                window.loadLocalData(`${year}-${String(month).padStart(2, '0')}`);
            });
        }
        
        const loadMonthlyData = (monthlyDataString) => {
             const monthKey = `${currentYearBs}-${String(currentMonthBs).padStart(2, '0')}`;
             let monthlyVariables = {};
             if (monthlyDataString) {
                 try {
                     monthlyVariables = JSON.parse(monthlyDataString);
                 } catch(e) { console.error("Local Data Parse Error:", e); }
             }
             
             // Merge persistent loans config with monthly variable data (extra principal)
             monthlyData = { 
                incomes: monthlyVariables.incomes || initialData.incomes,
                expenses: monthlyVariables.expenses || initialData.expenses,
                loans: monthlyData.loans.map(config => {
                    const monthlyEntry = monthlyVariables.monthlyLoanData?.find(m => m.id === config.id);
                    return { 
                        ...config, 
                        extraPrincipal: monthlyEntry?.extraPrincipal || 0
                    };
                })
            };

            window.populateLists(monthlyData);
        }

        window.loadLocalData = function(monthKey) {
            const monthlyDataString = localStorage.getItem(`gharti_finances_${monthKey}`);
            loadMonthlyData(monthlyDataString);
            // FIX: Ensure DOM elements are available before updating status
            setTimeout(() => window.updateSyncStatus(`${monthKey} को डाटा Local Storage बाट लोड भयो। (Local Storage मोड)`, 'Local'), 0);
        }
        
        window.saveLocalData = function(monthKey, data) {
            try {
                 localStorage.setItem(`gharti_finances_${monthKey}`, JSON.stringify(data));
            } catch (e) {
                console.error("Local Storage Save Failed:", e);
            }
        }
        
        // --- SYNCHRONIZATION STATUS UPDATE ---
        window.updateSyncStatus = function(message, type) {
            const el = document.getElementById('syncStatus');
            const icon = document.getElementById('syncIcon');
            
            // Safety check for null elements
            if (!el || !icon) {
                 return;
            }

            el.textContent = message;
            
            // Use setAttribute for full class replacement on SVG/HTML
            el.setAttribute('class', 'flex items-center space-x-2 font-semibold p-1 rounded-lg');
            icon.setAttribute('class', 'h-4 w-4'); // Reset base classes on SVG

            let pathD = ''; // To hold the SVG path content

            // Apply type-specific classes and set icon path
            if (type === 'Loading') {
                 el.classList.add('text-primary-blue', 'bg-blue-50');
                 icon.classList.add('animate-spin', 'text-blue-600');
                 // Loading Icon Path (Spin)
                 pathD = `M4.332 7.643a1 1 0 01.765-1.896 9 9 0 0011.59 11.59 1 1 0 01-1.897.765l-.007-.008A7 7 0 014.332 7.643zm1.896 5.832a1 1 0 01-.765 1.896 9 9 0 00-11.59-11.59 1 1 0 011.897-.765l.008.007A7 7 0 016.228 13.475z`;
            } else if (type === 'Success') {
                 el.classList.add('text-primary-green', 'bg-green-50');
                 icon.classList.add('text-green-600');
                 icon.classList.remove('animate-spin');
                 // Checkmark Icon Path
                 pathD = `M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z`;
            } else { // Error, Local, or Default
                 el.classList.add('text-yellow-600', 'bg-yellow-50');
                 icon.classList.add('text-yellow-600');
                 icon.classList.remove('animate-spin');
                 // Alert Icon Path
                 pathD = `M8.257 3.099c.924-1.783 3.327-1.783 4.25 0l5.58 10.799c.924 1.783-.34 3.821-2.125 3.821H4.802c-1.784 0-3.049-2.038-2.125-3.821l5.58-10.799zM10 11a1 1 0 100-2 1 1 0 000 2zm0 2a1 1 0 100-2 1 1 0 000 2z`;
            }
            
            icon.innerHTML = `<path fill-rule="evenodd" d="${pathD}" clip-rule="evenodd" />`;
        }


        // --- CALENDAR AND NAVIGATION FUNCTIONS (unchanged) ---

        const getTodayBs = () => {
             // Approximation of current date
             const now = new Date();
             const currentBsYear = 2082; // Using 2082 as base year for approximation
             const currentBsMonth = 1; // Assuming Baisakh (01) starts roughly in April
             
             // This is a simple approximation and should be replaced by a proper BS converter for production
             return { year: currentBsYear, month: currentBsMonth };
        }
        
        window.changeMonth = function() {
            currentYearBs = parseInt(document.getElementById('bsYear').value);
            currentMonthBs = parseInt(document.getElementById('bsMonth').value);
            loadMonthData(currentYearBs, currentMonthBs);
        }

        window.navigateMonth = function(direction) {
            let newYear = currentYearBs;
            let newMonth = currentMonthBs + direction;

            if (newMonth < 1) {
                newMonth = 12;
                newYear -= 1;
            } else if (newMonth > 12) {
                newMonth = 1;
                newYear += 1;
            }
            
            const yearSelector = document.getElementById('bsYear');
            const monthSelector = document.getElementById('bsMonth');

            if (yearSelector) yearSelector.value = newYear;
            if (monthSelector) monthSelector.value = newMonth;

            currentYearBs = newYear;
            currentMonthBs = newMonth;
            
            loadMonthData(currentYearBs, currentMonthBs);
        }

        const initMonthSelectors = () => {
            const today = getTodayBs();
            currentYearBs = today.year;
            currentMonthBs = today.month;

            const yearSelector = document.getElementById('bsYear');
            const monthSelector = document.getElementById('bsMonth');

            if (!yearSelector || !monthSelector) return; // Safety check

            const startYear = 2080;
            const endYear = 2090;

            // Populate Year Selectors
            for (let y = startYear; y <= endYear; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelector.appendChild(option.cloneNode(true));
            }

            // Populate Month Selectors
            bsMonths.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = name;
                monthSelector.appendChild(option.cloneNode(true));
            });

            // Set default to current estimated BS month/year
            yearSelector.value = currentYearBs;
            monthSelector.value = currentMonthBs;
        }

        // --- AUTHENTICATION AND INITIALIZATION ---
        
        // This function handles Firebase initialization and user authentication.
        window.init = async function() {
            initMonthSelectors();
            
            const familyCodeEl = document.getElementById('familyCodeDisplay');
            
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // --- CORE AUTHENTICATION LOGIC ---
                    // Tries to sign in with the provided token (for verified users), 
                    // otherwise signs in anonymously for basic access.
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    // --- END CORE AUTHENTICATION LOGIC ---
                    
                    userId = auth.currentUser?.uid || 'default-shared-user';
                    
                    if(familyCodeEl) familyCodeEl.textContent = appId;
                    // FIX: Deferred status update to ensure DOM elements are fully available.
                    setTimeout(() => window.updateSyncStatus('क्लाउड जडान भयो। (Shared Data)', 'Success'), 0);

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    db = null;
                    if(familyCodeEl) familyCodeEl.textContent = 'LOCAL-MODE';
                    // FIX: Deferred status update for error case.
                    setTimeout(() => window.updateSyncStatus('त्रुटि: क्लाउड जडान टुट्यो। (Local Storage मोड)', 'Error'), 0);
                }
            } else {
                db = null;
                userId = MANUAL_FAMILY_ID;
                if(familyCodeEl) familyCodeEl.textContent = MANUAL_FAMILY_ID || 'LOCAL-MODE';
                // FIX: Deferred status update for missing config case.
                setTimeout(() => window.updateSyncStatus('त्रुटि: Firebase कन्फिग हराइरहेको छ। (Local Storage मोड)', 'Error'), 0);
            }
            
            loadMonthData(currentYearBs, currentMonthBs);
        }
        
        // Utility for message boxes
        window.showMessage = function(title, message, buttonText = "बन्द गर्नुहोस्", buttonClass = "bg-primary-blue hover:bg-blue-600") {
             const msgBox = document.createElement('div');
            msgBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            msgBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-3">${title}</h3>
                    <p class="text-gray-700">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full text-white py-2 rounded-lg transition duration-150 ${buttonClass}">${buttonText}</button>
                </div>
            `;
            document.body.appendChild(msgBox);
        }

        window.viewSource = function() {
            window.showMessage("जानकारी", "यो फाइल एक सहयोगी प्लेटफर्म भित्र चल्दैछ। स्रोत कोड हेर्नका लागि तपाईंले कोड एडिटर ट्याबमा जानुहोस्।", "ठीक छ");
        }
        
        window.exportData = function() {
            window.showMessage("डाटा निर्यात", "यो कार्यक्षमता विकास अन्तर्गत छ।", "ठीक छ", "bg-primary-green hover:bg-green-600");
        }
        
        // --- FINAL DOM INITIALIZATION ---
        // Ensure window.init runs only after the full DOM is loaded and elements are available.
        document.addEventListener('DOMContentLoaded', window.init);


    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-[Inter]">
    <style>
        /* Custom styles for appearance */
        .text-primary-blue { color: #1c64f2; }
        .bg-primary-blue { background-color: #1c64f2; }
        .text-primary-green { color: #0e9f6e; }
        .bg-primary-green { background-color: #0e9f6e; }
        .text-primary-red { color: #f05252; }
        
        /* Ensure inputs and selects within loan cards are visually subtle when not focused */
        .loan-config-input {
            transition: all 0.2s;
        }
    </style>

    <!-- Header and Status Bar -->
    <div class="max-w-4xl mx-auto mb-6 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">घर्ती परिवारको वित्तीय व्यवस्थापन ड्यासबोर्ड</h1>
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center text-xs text-gray-500 space-y-2 sm:space-y-0">
            <div id="syncStatus" class="flex items-center space-x-2 font-semibold p-1 rounded-lg">
                <svg id="syncIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <!-- Initial Path (Content is replaced by JS on load based on connection status) -->
                    <path d="M10 3a7 7 0 100 14 7 7 0 000-14z" clip-rule="evenodd" fill-rule="evenodd"/>
                </svg>
                जडानको लागि पर्खँदै...
            </div>
            <div class="text-sm font-medium flex items-center space-x-3">
                <span class="text-gray-600">परिवारको साझा डाटा कोड:</span> 
                <span id="familyCodeDisplay" class="font-bold text-primary-blue bg-blue-100 px-2 py-0.5 rounded-md shadow-sm select-all">...</span>
                <button onclick="document.execCommand('copy', false, document.getElementById('familyCodeDisplay').textContent)" class="text-gray-400 hover:text-primary-blue transition duration-150" title="कोड प्रतिलिपि गर्नुहोस्">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h2m0-10h8m-8 0v4m8-4v4m8-4H18a2 2 0 00-2 2v10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Monthly Cash Flow Management (Left Column) -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-fit">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 flex items-center justify-between">
                <span>मासिक नगद प्रवाह व्यवस्थापन</span>
                <div class="flex items-center space-x-2">
                    <button onclick="window.viewSource()" class="text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 p-1 rounded-md border border-gray-300">
                        स्रोत
                    </button>
                    <button onclick="window.exportData()" class="text-sm font-medium text-primary-green hover:text-green-700 transition duration-150 p-1 rounded-md border border-gray-300">
                        डाटा निर्यात गर्नुहोस् (CSV)
                    </button>
                </div>
            </h2>

            <!-- Month Selector (Bikram Sambat) -->
            <div class="flex items-center justify-center space-x-3 mb-4 p-3 bg-blue-50 rounded-xl shadow-inner">
                <button onclick="window.navigateMonth(-1)" class="p-2 text-blue-700 hover:bg-blue-200 rounded-lg transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <select id="bsYear" onchange="window.changeMonth()" class="p-2 border border-blue-300 rounded-lg text-sm bg-white"></select>
                <select id="bsMonth" onchange="window.changeMonth()" class="p-2 border border-blue-300 rounded-lg text-sm bg-white w-36"></select>
                <button onclick="window.navigateMonth(1)" class="p-2 text-blue-700 hover:bg-blue-200 rounded-lg transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <!-- Income Section -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-lg font-medium text-primary-green mb-3 flex justify-between items-center">
                    <span>आम्दानी (Income)</span>
                    <span id="totalIncome" class="text-xl font-bold">₹ 0.00</span>
                </h3>
                <div id="incomeList">
                    <!-- Income rows will be injected here -->
                </div>
                <button onclick="window.addRow('incomeList')" class="w-full mt-2 py-2 text-sm text-primary-green border border-primary-green rounded-lg hover:bg-green-50 transition duration-150 flex items-center justify-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>आयको स्रोत थप्नुहोस्</span>
                </button>
            </div>

            <!-- Expense Section -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-lg font-medium text-primary-red mb-3 flex justify-between items-center">
                    <span>खर्च (Expense)</span>
                    <span id="totalExpense" class="text-xl font-bold">₹ 0.00</span>
                </h3>
                <div id="expenseList">
                    <!-- Expense rows will be injected here -->
                </div>
                <button onclick="window.addRow('expenseList')" class="w-full mt-2 py-2 text-sm text-primary-red border border-primary-red rounded-lg hover:bg-red-50 transition duration-150 flex items-center justify-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>खर्चको शीर्षक थप्नुहोस्</span>
                </button>
            </div>

            <!-- Summary -->
            <div class="space-y-3 pt-4">
                <div class="flex justify-between items-center text-lg font-medium">
                    <span class="text-gray-600">कुल मासिक मूलधन कटौती (Total Principal Reduction):</span>
                    <span id="totalPrincipalReduction" class="text-primary-blue font-bold">₹ 0.00</span>
                </div>
                <div class="flex justify-between items-center text-xl font-extrabold p-3 rounded-lg shadow-inner bg-gray-100">
                    <span class="text-gray-800">शुद्ध नगद प्रवाह (Net Cash Flow):</span>
                    <span id="netCashFlow" class="text-green-600">₹ 0.00</span>
                </div>
            </div>

            <!-- Month Navigation at Bottom -->
            <div class="flex justify-between mt-6 pt-4 border-t border-gray-200">
                <button onclick="window.navigateMonth(-1)" class="flex items-center px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 transition duration-150 text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    अघिल्लो महिना
                </button>
                <button onclick="window.navigateMonth(1)" class="flex items-center px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 transition duration-150 text-sm font-medium">
                    अर्को महिना
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

        </div>
        
        <!-- Loan Tracking Cards (Right Column) -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- TOTAL LOANS SUMMARY -->
             <div class="bg-gray-800 text-white p-4 rounded-xl shadow-xl border-4 border-yellow-400 sticky top-0 z-10">
                <h3 class="text-xl font-extrabold mb-3 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>कुल ऋण सारांश</span>
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-1">
                        <span class="font-medium">कुल बाँकी रकम (Total Outstanding):</span>
                        <span id="totalOutstandingBalance" class="text-lg font-bold text-red-400">₹ 0.00</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-700 pb-1">
                        <span class="font-medium">कुल मासिक किस्ता (Total EMI):</span>
                        <span id="totalScheduledEMI" class="text-lg font-bold text-green-400">₹ 0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium">बाँकी किस्ता (Longest Remaining):</span>
                        <span id="totalPaymentsRemaining" class="text-lg font-bold text-yellow-400">0</span>
                    </div>
                </div>
            </div>

            <!-- Dynamic Loan Cards Container -->
            <div id="loansContainer" class="space-y-6">
                <!-- Loan cards will be rendered here dynamically -->
            </div>
            
            <!-- Add New Loan Button -->
            <button onclick="window.addLoan()" class="w-full py-3 bg-primary-blue text-white rounded-xl shadow-lg hover:bg-blue-600 transition duration-150 flex items-center justify-center space-x-2 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>नयाँ ऋण थप्नुहोस्</span>
            </button>

        </div>
    </div>
</body>
</html>
